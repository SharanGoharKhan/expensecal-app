var app = angular.module('App',['ui.router','restangular','ngCookies','ngSanitize','angular-momentjs', 'ngFileUpload','LocalStorageModule','oc.lazyLoad']);



app.run(["$rootScope", "$location", "$state", "$moment", "localStorageService", function($rootScope, $location, $state,$moment,localStorageService){
	var env = $location.host().split('.').pop();
	var protocol = "http";
	$rootScope.app = {
		"name" : "Expensecal",
		"apiUrl" : protocol + "://api.expensecal." + env,
		"appUrl" : protocol + "://app.expensecal." + env,
		"env" : env
	};
	$rootScope.user=localStorageService.get("$user");
}]);

var app = angular.module('App');

app.config(["$stateProvider", function($stateProvider){
	$stateProvider
		.state("app.public.signup",{
			url: '/signup',
			templateUrl: "/templates/components/public/signup/signup.html",
			controller: "SignupController"
		})
}]); 
app.controller("SignupController", ["$scope", "$http", "localStorageService", "$rootScope", "Restangular", "$state", function ($scope,$http,localStorageService,$rootScope,Restangular,$state) {
	$scope.register = function()
	{
		$http.post($scope.app.apiUrl+"/auth/register",$scope.user)
			.then(function successCallback(response){
				$rootScope.$user=response.data;
				localStorageService.set('$user',$rootScope.$user);
			},function errorCallback(response)
			{
				console.log(response);
			});
	}
}]);
var app = angular.module('App');

app.config(["$stateProvider", function($stateProvider){
	$stateProvider
		.state("app.public.signin",{
			url: "/signin",
			templateUrl: "/templates/components/public/signin/signin.html",
			controller: "SigninController"
		})
}]); 

app.controller("SigninController", ["$scope", "$http", "localStorageService", "$rootScope", "Restangular", "$state", function ($scope,$http,localStorageService,$rootScope,Restangular,$state) {
	$scope.login=function()
	{
		$http.post($scope.app.apiUrl+"/auth/login",$scope.user)
			.then(function statusChangeCallback(response){
				$rootScope.$user=response.data;
				localStorageService.set('$user',$rootScope.$user);
				$state.go('app.public.home');
			},function errorCallback(response)
			{
				console.log("error");
			});
		
	}
}]);
var app = angular.module('App');

app.config(["$stateProvider", function($stateProvider){
	$stateProvider
		.state("app.public.home",{
			url: "/home",
			templateUrl: "/templates/components/public/home/home.html",
			controller: "HomeController"
		})
}]); 

app.controller("HomeController", ["$scope", "$rootScope", function ($scope,$rootScope) {
	$scope.message = "home controller";
}]);
var app = angular.module('App');

app.config(["$stateProvider", function($stateProvider){
	$stateProvider
		.state("app.public.expense",{
			url: '/expense',
			templateUrl: "/templates/components/public/expense/expense.html",
			controller: "ExpenseController",
			resolve:
			{
				$categories: ["Restangular", function(Restangular)
				{
					return Restangular.all('categories').getList(); 
				}],
				$expenses: ["Restangular", function(Restangular)
				{
					return Restangular.all('expense').getList();
				}]
			}
		})
}]); 
app.controller("ExpenseController", ["$scope", "Restangular", "$categories", "localStorageService", "$expenses", "$http", function ($scope,Restangular,$categories,localStorageService,$expenses,$http) {
	var baseExpense = $expenses;
	$scope.expense={};
	$scope.user = localStorageService.get('$user');
	$scope.categories=$categories;
	//TODO fix hard coded value
	$scope.expense.user_id = $scope.user.id;
	$scope.expense.category_id = 1;
	$scope.addExpense = function()
	{
		baseExpense.post($scope.expense);
	}
	$scope.showExpense = function()
	{
		$scope.allExpenses=[];
		$http.get($scope.app.apiUrl+"/expenseById"+"/"+$scope.user.id)
			.then(function statusChangeCallback(response){
				$scope.allExpenses=response;
			},function errorCallback(response)
			{
				console.log("error");
			});
		//$scope.allExpenses = Restangular.all('expenseById',2).getList();
		console.log($scope.allExpenses);
	}
}]);
var app = angular.module("App");

app.config(["$stateProvider", function($stateProvider){
	$stateProvider
		.state("app.public.category",{
			url: "/category",
			templateUrl: "/templates/components/public/category/category.html",
			controller: "CategoryController",
			resolve: 
			{
				$categories: ["Restangular", function(Restangular)
				{
					return Restangular.all('categories').getList(); 
				}]
			}
		})
}]); 

app.controller("CategoryController", ["$scope", "$rootScope", "$categories", function ($scope, $rootScope,$categories) {
	$scope.addCategory = function()
	{
		var baseCategory = $categories;
		baseCategory.post($scope.category);
	}
	$scope.showCategory = function()
	{
		$scope.category=$categories;
	}
	$scope.editCategory = function()
	{
		console.log("Edit Category called");
	}
}]);
var app = angular.module('App');
app.controller('AppController', ["$scope", "$rootScope", "localStorageService", "$state", function ($scope,$rootScope,localStorageService,$state) {
}]);

var app = angular.module("App");

app.directive('exDropdown', [function() {
	return {
		restrict: 'A',
		scope: false,
		link: function(scope, element, attrs) {
      var result;
    		$(function(){
          $(".dropdown-menu li a").click(function(){
          $(".btn:first-child").text($(this).text());
          result = $(".btn:first-child").val($(this).text());
        });
        // var cat=element[0].querySelector('a');
      });
		}
	};
}]);
var app = angular.module('App');
app.config(["$stateProvider", "$urlRouterProvider", "$locationProvider", function($stateProvider,$urlRouterProvider, $locationProvider){
	
	$locationProvider.html5Mode({ enabled: true, requireBase: true });
    $stateProvider
        .state('app',{
            abstract: true,
            controller: 'AppController',
            template: '<ui-view></ui-view>'
        });
    $urlRouterProvider.otherwise('/home');    	
}]);
app.controller('AppController',["$scope", "$rootScope", function($scope, $rootScope){

    $rootScope.$on('$locationChangeSuccess', function(e) {
        /* To set the page scroll Top to 0, to show the start of page. */
        window.scrollTo(0,0);
    });
}]);

var app = angular.module('App');

app.config(["RestangularProvider", function(RestangularProvider){
	RestangularProvider.setRestangularFields({
	  id: "_id"
	});
}]);

app.run(["$rootScope", "$http", "Restangular", "$location", function($rootScope, $http, Restangular,$location){
	var env = $location.host().split('.').pop();
	var protocol = (env == 'com') ? "https" : "http";
	$rootScope.app = {
  	    "name" : "ExpenseCal",
  	    "apiUrl": protocol +"://api.expensecal." + env,
        "appUrl": protocol +"://app.expesecal." + env,
        "env": env
  	};
    Restangular.setBaseUrl($rootScope.app.apiUrl);
    Restangular.setDefaultHeaders({'Content-Type': 'application/json'});

    $http.defaults.useXDomain = true;
}]);
var app = angular.module ('App');

app.config(["$httpProvider", function($httpProvider){
	$httpProvider.interceptors.push('httpInterceptor');
}]);

app.factory('httpInterceptor', ["$q", "$rootScope", "$injector", "$location", function ($q, $rootScope, $injector, $location) {
    return {
        'request': function (config) {
            return config || $q.when(config);
        },
        'response': function(response) {        	
            return response;
        },
        'requestError': function (rejection) {
            return $q.reject(rejection);
        },
        'responseError': function (rejection) {
            return $q.reject(rejection);           
        }
    };
}]);
var app = angular.module('App');

app.config(["$stateProvider", function($stateProvider){
	$stateProvider
		.state("app.public",{
			abstract: true,
			templateUrl: "/templates/components/public/public.html",
			controller: "PublicController"
		})
}]); 
app.controller("PublicController", ["$scope", "$rootScope", "localStorageService", "$state", function ($scope,$rootScope,localStorageService,$state) {
	$rootScope.user=localStorageService.get("$user");
	$scope.user=$rootScope.user;
	if($scope.user)
	{
		console.log("user is not empty");
	}
	else
		$state.go("app.public.signin");
	console.log("Before signout: "+$scope.user);
	$scope.signout = function()
	{
		console.log("After signout: "+$scope.user);
		localStorageService.remove('$user');
		$rootScope.user = null;
		$scope.user = null;
		$scope.$apply();
		$state.go("app.public.signin");
	}
}]);
